<!DOCTYPE html>
<html>
{% load staticfiles %}
<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>进销存管理系统</title>

    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
    <link href="{% static 'font-awesome/css/font-awesome.css' %}" rel="stylesheet">

    <!--add-->
    ﻿<link rel="stylesheet" href="{% static 'bootstrap_above/bootstrap-table-develop/dist/bootstrap-table.css' %}"/>
    ﻿<link href="{% static 'bootstrap_above/x-editable-develop/dist/bootstrap-editable/css/bootstrap-editable.css' %}" rel="stylesheet">

    <!-- FooTable -->
    <link href="{% static 'css/plugins/footable/footable.core.css' %}" rel="stylesheet">

    <link href="{% static 'css/animate.css' %}" rel="stylesheet">
    <link href="{% static 'css/style.css' %}" rel="stylesheet">
    <style>
        /*overwrite a.editable-empty*/

        a.editable-empty{
            width: 55px;
            height: 25px;
            display: inline-block;

        }
        .not-wrap{
            white-space: nowrap;
        }

        .editable-click, 
        a.editable-click, 
        a.editable-click:hover {
            text-decoration: none;
            border-bottom: dashed 0px #0088cc;
            /*    重写去除下边框
            */
        }


        /* 设置input的样式 
            bootstrap table padding为8px,加上左border为1px
            editable input 的样式中padding:6 24 6 2;border 1px;
        */
        .inputclass{
            width:100% !important;min-width:87px;
            height:30px;
            padding-left: 2px;
        }

        .button-margin{
            margin-bottom:20px;
        }

        .fixed{
            table-layout: fixed;
            
        }
    </style>
</head>

<body>

    <div id="wrapper">
        {% include 'nav.html' %}

        <div id="page-wrapper" class="gray-bg">

            {% include 'header.html' %}

            <div class="row wrapper border-bottom white-bg page-heading">
           <div class="ibox-title">
                            <h5>添加购货订单</h5>
                            <div class="ibox-tools">           
                                <a type="﻿button" class="btn btn-primary"  href="{% url 'purchaseOrderList' %}">
                                    <i class="fa fa-reply"></i>
                                </a>
                            </div>
                        </div>
            </div>
        <div class="wrapper wrapper-content animated fadeInRight">


            <div class="row">
                <div class="col-lg-12">
                    <div class="ibox float-e-margins">
 ﻿<div class="modal " id="materialNameModal" tabindex="-1" role="dialog" aria-hidden="true">
                            <div class="modal-dialog" style="width:1000px;">
                                <div class="modal-content animated bounceInRight">
                                     <div class="modal-header">
                                            <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                                            <i class="fa fa-laptop modal-icon"></i>
                                            <h4 class="modal-title">选择毛料</h4>
                                            <i id="indexFlag" style="display: none;"></i>
                                        </div>
                                        <div class="modal-body">
                                            <div class="container-fluid">
                                                <div class="row form-horizontal">
                                                <div class="form-group">
                                                        <h4>毛料:</h4>
                                                    <div class="col-md-12">
                                                      <table id="goodsTable"></table>
                                                    </div>
                                                </div>
                                                </div>                  
                                            </div>                                                  
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-primary" data-dismiss="modal" style="margin-bottom:0px;">关闭</button>
                                            <button id="testid" type="button" data-dismiss="modal" class="btn btn-primary" onclick="getValues()">选择</button>
                                            
                                        </div>
                                   </div>
                                </div>
                            </div>



    <div class="modal " id="chirdTableModel" tabindex="-1" role="dialog" aria-hidden="true">
                            <div class="modal-dialog" style="width:1000px;">
                                <div class="modal-content animated bounceInRight">
                                     <div class="modal-header">
                                            <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                                            <i class="fa fa-laptop modal-icon"></i>
                                            <h4 class="modal-title">选择购货订单</h4>
                                            <i id="indexFlag" style="display: none;"></i>
                                        </div>
                                        <div class="modal-body">
                                            <div class="container-fluid">
                                                <div class="row form-horizontal">
                                                <div class="form-group">
                                                        <h4>购货订单:</h4>
                                                    <div class="col-md-12">
                                                      <table id="secondTab"></table>
                                                    </div>
                                                </div>
                                                </div>                  
                                            </div>                                                  
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-primary" data-dismiss="modal" style="margin-bottom:0px;">关闭</button>
                                            <button id="secondsub" type="button" data-dismiss="modal" class="btn btn-primary" onclick="getValues2()">选择</button>
                                            
                                        </div>
                                   </div>
                                </div>
                            </div>


                        <div class="ibox-content">
                            <div class="text-center">
                             <h4 class="pull-left" style="position: absolute;">订单号:</h4>
    <div class="btn-group pull-right" role="toolbar" aria-label="...">
      <button type="button" class="btn btn-primary" style="margin-right: 2px;" onclick="complete_return()">取货结束</button>
      <button type="button" class="btn btn-primary" style="margin-right: 2px;" onclick="submitData1()">提交</button>
      <button type="button" class="btn btn-primary" id="addRowbtn"><i class="fa fa-plus"></i></button>
    </div>
                            <h2>定货情况</h2>
                            </div>
                            <table class="table-responsive" id="basicTable">
                            </table>
                        
                             <div class="text-center">
    <div class="btn-group pull-right" role="toolbar" aria-label="...">
      <button type="button" class="btn btn-primary" style="margin-right: 2px;" onclick='submitData2()'>提交</button>
      <button type="button" class="btn btn-primary" id="chirdTableaddRowbtn"><i class="fa fa-plus"></i></button>
    </div>
                                <h2>取货情况</h2>
                            </div>
                            <table class="table-responsive" id="chirdTable">
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>








        <div class="footer">
            <div class="pull-right">
                <strong>www</strong>
            </div>
            <div>
                <strong>Copyright</strong> 进销存管理系统 &copy; 2017-2018
            </div>
        </div>

        </div>
        </div>





    <!-- Mainly scripts -->
    <script src="{% static 'js/jquery-3.1.1.min.js' %}"></script>
    <script src="{% static 'js/bootstrap.min.js' %}"></script>
    <script src="{% static 'js/plugins/metisMenu/jquery.metisMenu.js' %}"></script>
    <script src="{% static 'js/plugins/slimscroll/jquery.slimscroll.min.js' %}"></script>


    <!-- add -->
    ﻿<script type="text/javascript" src="{% static 'bootstrap_above/bootstrap-table-develop/dist/bootstrap-table.js' %}"></script>
    <script type="text/javascript" src="{% static 'bootstrap_above/bootstrap-table-develop/dist/locale/bootstrap-table-zh-CN.js' %}"></script>
    <script type="text/javascript" src="{% static 'bootstrap_above/bootstrap-table-develop/dist/extensions/export/bootstrap-table-export.js' %}"></script>

	  <!-- <script src="../static/bootstrap_above/tableExport/libs/pdfmake/pdfmake.min.js"></script>
		<script src="../static/bootstrap_above/tableExport/libs/pdfmake/vfs_fonts.js"></script> -->
        <script type="text/javascript" src="{% static 'bootstrap_above/tableExport/libs/FileSaver/FileSaver.min.js' %}"></script>
        <script type="text/javascript" src="{% static 'bootstrap_above/tableExport/libs/jsPDF/jspdf.min.js' %}"></script>
        <script type="text/javascript" src="{% static 'bootstrap_above/tableExport/libs/jsPDF-AutoTable/jspdf.plugin.autotable.js' %}"></script>
        <script type="text/javascript" src="{% static 'bootstrap_above/tableExport/tableExport.js' %}"></script>

        ﻿<script src="{% static 'bootstrap_above/x-editable-develop/dist/bootstrap3-editable/js/bootstrap-editable.js' %}"></script>
        <script src="{% static 'bootstrap_above/bootstrap-table-develop/dist/extensions/editable/bootstrap-table-editable.js' %}"></script>





    <!-- FooTable -->
    <script src="{% static 'js/plugins/footable/footable.all.min.js' %}"></script>

    <!-- Custom and plugin javascript -->
    <script src="{% static 'js/inspinia.js' %}"></script>
    <script src="{% static 'js/plugins/pace/pace.min.js' %}"></script>

<!-- ajax请求时开启csrf -->
<script type="text/javascript">
    $.ajaxSetup({headers: {"X-CSRFToken": '{{ csrf_token }}'}});
</script>
    <!-- Page-Level Scripts -->
    <script>
        $(document).ready(function() {

            $('.footable').footable();
            $('.footable2').footable();

        });



<!-- 随机生成订单号，此方法为别人的，需要进一步改写 -->

function randomNum(minNum,maxNum){
var today = new Date();
var day   = today.getDate(); //获取当前日(1-31)
var month = today.getMonth() + 1; //显示月份比实际月份小1,所以要加1
var year  = today.getYear();  //获取完整的年份(4位,1970-????)  getFullYear()
var years=today.getFullYear();
years= years<99?"20"+years:years;
month    = month<10?"0"+month:month;  //数字<10，实际显示为，如5，要改成05
day   = day<10?"0"+day:day;
var hh=today.getHours();
hh   = hh<10?"0"+hh:hh;
var ii=today.getMinutes();
ii   = ii<10?"0"+ii:ii;
var ss= today.getSeconds();
ss   = ss<10?"0"+ss:ss;
var dada = years+month+day+hh+ii+ss;//时间不能直接相加，要这样相加！！！14位

    switch(arguments.length){
        case 1:
            return dada+parseInt(Math.random()*minNum+1,10);
            //newOrderId = dada+parseInt(Math.random()*minNum+1,10);
        break;
        case 2:
            return dada+parseInt(Math.random()*(maxNum-minNum+1)+minNum,10);
            //newOrderId = dada+parseInt(Math.random()*(maxNum-minNum+1)+minNum,10);
        break;
            default:
                return 0;
                //newOrderId = 0;
            break;
    }
}
{% if ord_num %}
var newOrderId = '{{ ord_num }}';
{% else %}
var newOrderId = randomNum(1,1000);
{% endif %}
    $('h4.pull-left').text('订单号:'+newOrderId);



      var Rowindex = 0;//用于删除数据时的唯一标志

      $(function () {
                $.fn.bootstrapTable.columnDefaults.valign = 'middle';//设置垂直居中    
                 $.fn.bootstrapTable.columnDefaults.align = 'center';
                $.fn.bootstrapTable.columnDefaults.width = '200px';
                $.fn.editable.defaults.mode = 'inline';//编辑方式为内联方式
                $.fn.editable.defaults.showbuttons = false;//设置所有的元素不显示按钮
                $.fn.editable.defaults.emptytext = '';//设置默认空文本
                $.fn.editable.defaults.onblur = "submit";//当失去焦点时自动提交
                $.fn.editable.defaults.inputclass="inputclass";//定义input的样式
          $.fn.bootstrapTable.columnDefaults.class='not-wrap';
				<!--table start-->
			    $('#basicTable').bootstrapTable({
			    	method:'get',
			        dataType:'json',
			        contentType: "application/x-www-form-urlencoded",
			        striped: true,                              //是否显示行间隔色
			        sidePagination: "server",           //分页方式：client客户端分页，server服务端分页（*）
                    url: "{% url 'purchaseOrder-list' %}",
                    dataField: "data",
                    responseHandler:basicTable_responseHandler,//请求数据成功后，渲染表格前的方法
                    queryParams:basicTable_queryParams,//请求服务器时所传的参数
			        //showColumns:true,
			        pagination:true,
			        minimumCountColumns:2,
			        pageNumber:1,                       //初始化加载第一页，默认第一页
			        pageSize: 10,                       //每页的记录行数（*）
			        pageList: [10, 15, 20, 25],        //可供选择的每页的行数（*）
			        uniqueId: "id",                     //每一行的唯一标识，一般为主键列
			    //    showExport: true,
			    //    exportDataType: 'all',
			    //    exportTypes:[ 'csv', 'txt', 'sql', 'doc', 'excel', 'xlsx', 'pdf'],  //导出文件类型
                    rowStyle:complete_return_style,
			        columns: [
                    {
                        checkbox:true,
                    },
                    {
                        field:'id',
                        title:'id',
                        visible:false,
                    },
                    {
                        field:'index',
                        title: 'index',
                        formatter: function(value, row, index){
                            row.index = index;
                            return index;
                        }
                    },
                    {
				        field: 'ord_num',
						title: '订单号',
				    },
                     {
                        field: 'name',
                        title: '品种',
                    },
                     {
                        field: 'packaging_name',
                        title: '包装',
                    },
                     {
                        field: 'color_num',
                        title: '色号',
                    },
                    {
                        field: 'color_name',
                        title: '颜色',
                    },
                     {
                        field: 'dyelot_num',
                        title: '缸号',
                    },
                    {
                        field: 'batch_num',
                        title: '批号',
                    },
                    {
                        field: 'number',
                        title: '订货数量',
                        editable: {
								type: 'text',
								}
                    },
                     {
                        field: 'price',
                        title: '订货单价',
                        editable: {
								type: 'text',
								}
                    },
                    {
                        field: 'total',
                        title: '订货总额',
                    },
                    {
                        field: 'preorder_num',
                        title: '可赊数量',
                        editable: {
								type: 'text',
								}
                    },
                    {
                        field: 'preorder_price',
                        title: '赊货单价',
                        editable: {
								type: 'text',
								}
                    },
                     {
                        field: 'preorder_total',
                        title: '赊货总额',
                    },
                     {
                        field: 'tax_price',
                        title: '含税单价',
                        editable: {
								type: 'text',
								}
                    },
                     {
                        field: 'tax_total',
                        title: '税额',
                    },
                     {
                        field: 'order_date',
                        title: '订购时间',
                         editable: {
                             //添加设置为弹出式,将显示在右边
                             mode:'popup',
                             placement:'left',
                             showbuttons:true,
                             type: 'date',
                             format: 'yyyy-mm-dd',
                             viewformat: 'yyyy-mm-dd',
                             datetimepicker: {
                                 weekStart: 1
                             }
                         }
                    },
                     {
                        field: 'supplier',
                        title: '供应商',
                        editable: {
                            type: 'select',
                            pk: 1,
                            autotext:'always',//添加该标签使得html显示text
                            source: function(){
                                var result = [];
                                $.ajax({
                                    url: "{% url 'client-list' %}",
                                    data: {'clientType_name': '供应商'},
                                    type: 'get',
                                    dataType: 'json',
                                    'async': false,
                                    success: function(data, status){
                                        $.each(data, function(key, value){
                                            result.push({ value: value.id, text: value.name });
                                        });
                                    }
                                });
                                return result;
                            },
                            noeditFormatter: function (value,row,index) {
                                            var result={filed:"supplier",value:value,class:"btn-primary",style:"padding:5px 10px;"};
                                            return result;
                            }
                        }
                    },
                     {
                        field: 'delivery_date',
                        title: '交货日期',
                        editable: {
                                //添加设置为弹出式,将显示在右边
                                mode:'popup',
                                placement:'left',
                                showbuttons:true,
                                type: 'date',
                                format: 'yyyy-mm-dd',    
                                viewformat: 'yyyy-mm-dd',    
                                datetimepicker: {
                                    weekStart: 1
                                }
                            } 
                    },
                    {
                        field: 'deadline',
                        title: '最晚取货日期',
                        editable: {
                                //添加设置为弹出式,将显示在右边
                                mode:'popup',
                                placement:'left',
                                showbuttons:true,
                                type: 'date',
                                format: 'yyyy-mm-dd',    
                                viewformat: 'yyyy-mm-dd',    
                                datetimepicker: {
                                    weekStart: 1
                                }
                            } 
                    },
                    {
                        field:'check_status',
                        title:'审核状态'
                    },
                        {
                            field:'complete_return',
                            title:'是否回毛结束'
                        },
                    {
                        field: 'remarks',
                        title: '备注',
                        editable: {
								type: 'text',
								}
                    }

					]
				});
              
				$('#addRowbtn').click(function addOreder(){


							var rowsAccount = $('#basicTable').bootstrapTable('getData').length;

                var data = {
                        'id' :-1,
			            'index': '',
                        'ord_num': newOrderId,
                        'name': '',
                        'packaging_name': '',
                        'color_name': '',
                        'color_num': '',
                        'color':'',
                        'dyelot_num':'',
                        'batch_num':'',
                        'number':'',
                        'price':'',
                        'total':'',
                        'preorder_num':'',
                        'preorder_price':'',
                        'preorder_total':'',
                        'tax_price':'',
                        'tax_total':'',
                        'add_time':'',
                        'supplier':'',
                        'delivery_date':'',
                        'order_date':'',
                        'deadline':'',
                        'check_status':'',
                        'complete_return':'',
                        'remarks':'',
								};
                $('#basicTable').bootstrapTable('append',data);
            });

          //请求服务数据时所传参数
          function basicTable_queryParams(params){
              return {
                  pageSize : params.limit, //每一页的数据行数，默认是上面设置的10(pageSize)
                  pageIndex : params.offset/params.limit+1, //当前页面,默认是上面设置的1(pageNumber)
                  ord_num: newOrderId,
              }
          }
//请求成功方法
          function basicTable_responseHandler(result){
              //如果没有错误则返回数据，渲染表格
              return {
                  total : result.count, //总页数,前面的key必须为"total"
                  data : result.results //行数据，前面的key要与之前设置的dataField的值一致.
              };
          }
				<!--table end-->
				<!--   ------------------------------------------------------------------------------------------  -->
					<!--table2 start-->
						$('#chirdTable').bootstrapTable({
							method:'get',
                            responseHandler:chirdTable_responseHandler,
                            queryParams:chirdTable_queryParams,
                            url: "{% url 'take_goods-list' %}",
                            dataField: "data",
                            dataType:'json',
                            contentType: "application/x-www-form-urlencoded",
                            cache: false,
                            striped: true,                              //是否显示行间隔色
                            sidePagination: "server",           //分页方式：client客户端分页，server服务端分页（*）
                            pagination:true,
                            minimumCountColumns:2,
                            pageNumber:1,                       //初始化加载第一页，默认第一页
                            pageSize: 10,                       //每页的记录行数（*）
                            pageList: [10, 15, 20, 25],        //可供选择的每页的行数（*）
                            uniqueId: "id",                     //
                            rowStyle:complete_return_style,
							columns: [
                            {
                                checkbox:true,
                            },{
                        field:'index',
                        title: 'index',
                        formatter: function(value, row, index){
                            row.index = index;
                            return index;
                        }
                            },
                            {
									field: 'id',
									title: 'id',
                                visible:false,
							},
							{
                                field: 'take_date',
                                title: '取货时间',
                                editable: {
                                    //添加设置为弹出式,将显示在右边
                                    mode:'popup',
                                    placement:'left',
                                    showbuttons:true,
                                    type: 'date',
                                    format: 'yyyy-mm-dd',
                                    viewformat: 'yyyy-mm-dd',
                                    datetimepicker: {
                                        weekStart: 1
                                    }
                                }
                            },
							{
                            
                                    field: 'name',
                                    title: '品种',
                         },
							{
										field: 'take_num',
										title: '取货数量',
                                        editable: {
											type: 'text',
								}
							},
							{
										field: 'take_price',
										title: '取货单价',
                                        editable: {
                                            type: 'text',

								}
							},
							{
										field: 'take_total',
										title: '取货总额',
							},
							{

											field: 'take_people',
											title: '取货人',
												editable: {
										type: 'text',

									}
							},
                             {
                                field: 'warehouse',
                                title: '入库仓库',
                                editable: {
                                    type: 'select',
                                    pk: 1,
                                    autotext:'always',//添加该标签使得html显示text
                                    source: function(){
                                        var result = [];
                                        $.ajax({
                                            url: "{% url 'warehouse-list' %}",
                                            type: 'get',
                                            dataType: 'json',
                                            data: {'type': '原材料仓库'},
                                            'async': false,
                                            success: function(data, status){
                                                $.each(data, function(key, value){
                                                    result.push({ value: value.id, text: value.name });
                                                });
                                            }
                                        });
                                        return result;
                                    },
                                    noeditFormatter: function (value,row,index) {
                                                    var result={filed:"warehouse",value:value,class:"btn-primary",style:"padding:5px 10px;"};
                                                    return result;
                                    }
                                }
                            },
							{
										field: 'opposite_num',
										title: '对方单号',
                                        editable: {
                                            type: 'text',
                                        }
							},
                                {
                                    field: 'remarks',
                                    title: '备注',
                                    editable: {
                                        type: 'text',
                                    }
                                },
                                {
                                    field: 'complete_return',
                                    title: '是否回毛结束',
                                },
						]
					});
          //请求服务数据时所传参数
          function chirdTable_queryParams(params){
              return {
                  pageSize : params.limit, //每一页的数据行数，默认是上面设置的10(pageSize)
                  pageIndex : params.offset/params.limit+1, //当前页面,默认是上面设置的1(pageNumber)
                  ord_num: newOrderId,
              }
          }
//请求成功方法
          function chirdTable_responseHandler(result){
              //如果没有错误则返回数据，渲染表格
              return {
                  total : result.count, //总页数,前面的key必须为"total"
                  data : result.results //行数据，前面的key要与之前设置的dataField的值一致.
              };
          }

					$('#chirdTableaddRowbtn').click(function(){
									var data = {
										'id': -1,
										'add_time': '',
										'name': '',
										'take_num': '',
										'take_price':'',
										'take_total':'',
										'take_people':'',
										'warehouse': '',
                                        'opposite_num': '',
                                        'take_date': '',
                                        'remarks': '',
                                        'complete_return': '',
									};
									$('#chirdTable').bootstrapTable('append',data);
							});
					<!--table end-->
			});
                    $('#goodsTable').bootstrapTable({
                                method:'get',
                                dataType:'json',
                                dataField: 'data',
                                url: "{% url 'woolens-list' %}",
                                responseHandler: goodsTable_responseHandler,
                                queryParams: goodsTable_queryParams,
                                contentType: "application/x-www-form-urlencoded",
                                cache: false,
                                striped: true,                              //是否显示行间隔色
                                sidePagination: "client",           //分页方式：client客户端分页，server服务端分页（*）
                                showColumns:true,
                                pagination:true,
                                minimumCountColumns:2,
                                pageNumber:1,                       //初始化加载第一页，默认第一页
                                pageSize: 10,                       //每页的记录行数（*）
                                pageList: [10, 15, 20, 25],        //可供选择的每页的行数（*）
                                uniqueId: "id",   
                                search:true,
                  
                        columns: [
                        {
                            radio:true,
                        },
                        {
                            
                                    field: 'name',
                                    title: '毛料名称',          
                        },
                        {
                                    field: 'woolens_number',
                                    title: '编号',
                            
                            
                        },{
                                    field: 'abbreviation',
                                    title: '简称',
                           
                        },{
                                    field: 'element',
                                    title: '成分',
                             
                        },{
                                    field: 'cost',
                                    title: '色纱成本',
                                 
                        },{
                                    field: 'price',
                                    title: '色纱售价',
                             
                        },{
                                    field: 'clerk',
                                    title: '录入人',
                             
                        },{
                        field: 'packaging_name',
                        title: '包装',
                       
                    },
                     {
                        field: 'color_num',
                        title: '色号',
                       
                    },
                    {
                        field: 'color_name',
                        title: '颜色',
                     
                    },
                     {
                        field: 'dyelot_num',
                        title: '缸号',
                       
                    },
                    {
                        field: 'batch_num',
                        title: '批号',
                        
                    },
                        ]
                    });

function goodsTable_queryParams(params){
    return {
        pageSize : params.limit, //每一页的数据行数，默认是上面设置的10(pageSize)
        pageIndex : params.offset/params.limit+1, //当前页面,默认是上面设置的1(pageNumber)
        type: '原材料',
    };
}
//请求成功方法
function goodsTable_responseHandler(result){
    //如果没有错误则返回数据，渲染表格
    return {
        total : result.count, //总页数,前面的key必须为"total"
        data : result.results, //行数据，前面的key要与之前设置的dataField的值一致.
    }
}


$('#secondTab').bootstrapTable({
                                method:'get',
                                dataType:'json',
                                dataField: 'data',
                                url: "{% url 'purchaseOrder-list' %}",
                                queryParams: secondTab_query,
                                responseHandler: secondTab_response,
                                contentType: "application/x-www-form-urlencoded",
                                cache: false,
                                striped: true,                              //是否显示行间隔色
                                sidePagination: "client",           //分页方式：client客户端分页，server服务端分页（*）
                                showColumns:true,
                                pagination:true,
                                minimumCountColumns:2,
                                pageNumber:1,                       //初始化加载第一页，默认第一页
                                pageSize: 10,                       //每页的记录行数（*）毛料三
                                pageList: [10, 15, 20, 25],        //可供选择的每页的行数（*）
                                uniqueId: "id",
                                search:true,

                        columns: [
                        {
                            checkbox:true,
                        },
                        {
                            field:'id',
                            title:'id',
                            visible:false,
                        },
                        {

                                    field: 'name',
                                    title: '毛料名称',
                        },
                        {
                                    field: 'packaging_name',
                                    title: '包装',
                        },{
                                    field: 'color_name',
                                    title: '颜色',

                        },{
                                    field: 'color_num',
                                    title: '色号',
                        },{
                                field: 'dyelot_num',
                                title: '缸号',
                        },{
                                field: 'batch_num',
                                title: '批号',
                        },{
                                field: 'remain',
                                title: '剩余数量',

                        },{
                                    field: 'price',
                                    title: '订货单价',
                        },{
                                    field: 'remarks',
                                    title: '备注',
                        },

                        ]
                    });
			//请求服务数据时所传参数
function secondTab_query(params){
    return {
        pageSize : params.limit, //每一页的数据行数，默认是上面设置的10(pageSize)
        pageIndex : params.offset/params.limit+1, //当前页面,默认是上面设置的1(pageNumber)
        ord_num: newOrderId,
        remain: 0,
        complete_return: 'False',
    }
}
//请求成功方法
function secondTab_response(result){
    //如果没有错误则返回数据，渲染表格
    return {
        total : result.count, //总页数,前面的key必须为"total"
        data : result.results, //行数据，前面的key要与之前设置的dataField的值一致.
    }
}
//获取模态对话框中的内容
//

    function getValues(){
        //同样问题无法得到index
        // var values = JSON.stringify($('#goodsTable').bootstrapTable('getSelections'));
         var values = $('#goodsTable').bootstrapTable('getSelections');//获取select的值
        console.log(values);
         var rowdata = {
                        'woolens': values[0].id,  //获取了的物品种
                        };
         var dataSum = $.extend(values[0],rowdata);
         delete dataSum['number'];
         delete dataSum['price'];
         delete dataSum['remarks'];
         //更新一行
         $('#basicTable').bootstrapTable('updateRow',{index:$('#indexFlag').text(),row:dataSum});
     }
   
    $('h4.pull-left').text('订单号:'+newOrderId);

    //为basicTable添加双击事件
    $("#basicTable").on('dbl-click-cell.bs.table',function (field,value,row,$element,target){
        if(value == 'name')//双击时无法绑定是哪一个单元格,所以需要对单元格进行验证
        {
           
            var cellIndex = target[0].parentElement.rowIndex-1;//获取当前双击单元格的index
            $('#indexFlag').text(cellIndex);//将点击的单元的index传给模态对话款
            $('#materialNameModal').modal('toggle');//调用模态对话框
        }
    });
    //为chirdTable添加双击事件
    $("#chirdTable").on('dbl-click-cell.bs.table',function (field,value,row,$element,target){
        if(value == 'name')//双击时无法绑定是哪一个单元格,所以需要对单元格进行验证
        {
            var cellIndex = target[0].parentElement.rowIndex-1;//获取当前双击单元格的index
            $('#indexFlag').text(cellIndex);//将点击的单元的index传给模态对话款
            $('#chirdTableModel').modal('toggle');//调用模态对话框

        }   
    });
    //加载goodsTable表格
    function loadGoodsTable(){
        $('#goodsTable').bootstrapTable('load',arguments[0]);//为模态对话框加载数据
        if(arguments[1]){
            $('#goodsTable').bootstrapTable('hideColumn','id');
        }else{
            $('#goodsTable').bootstrapTable('showColumn','id');
        }
        $('#materialNameModal').modal('toggle');//调用模态对话框
    }



    //获取选择的数据
    function getSelect(tableid){
        var array = $('#'+arguments[0]).bootstrapTable('getSelections');
        return array;
    }

    //删除数据
    function remove(){
        var array = getSelect(arguments[0]);
        var deleteArr = new Array();
        for(var i=0;i<array.length;i++){
            deleteArr.push(array[i].index);
        }
        if(confirm('是否确定删除!')){
            $('#'+arguments[0]).bootstrapTable('remove',{field:'index',values:deleteArr});
        }
    }
    //操作对应的表格
    function remove1(){
        remove('basicTable');
    }

    function remove2(){
        remove('chirdTable');
    }

    //用于判断两个对象是否相同
    function isObjectValueEqual(a, b) {
        // Of course, we can do it use for in
        // Create arrays of property names
        var aProps = Object.getOwnPropertyNames(a);
        var bProps = Object.getOwnPropertyNames(b);

        // If number of properties is different,
        // objects are not equivalent
        if (aProps.length != bProps.length) {
            console.log('it is no equal');
            return false;
        }

        for(var i = 0; i < aProps.length; i++){
            var propName = aProps[i];

            // If values of same property are not equal,
            // objects are not equivalent
            if (a[propName] !== b[propName]) {
                console.log('it is no equal');
                return false;
            }
        }
        return true;
    }

    function material(arr){
        this.name = arr['name'];
        this.packaging = arr['packaging'];
        this.color = arr['color'];
        this.color_num = arr['color_num'];
        this.dyelot_num  = arr['dyelot_num'];
        this.batch_num = arr['batch_num'];
        this.supplier = arr['supplier'];
    }

    //取货表格中子表的点击事件
    $('#secondsub').click(function getValues(event){
        //获取所有选择的数据
        //判断选择的行数
        var values = $('#secondTab').bootstrapTable('getSelections');//获取select的值
        var arr = new Array();
        var tmp = [];
        for(var i=0;i<values.length;i++){
            arr.push(new material(values[i]));
            tmp.push(values[i]);
        }
        if(values.length>1){
            for(var i=1;i<arr.length;i++){
                if(!isObjectValueEqual(arr[i],arr[i-1])){
                    event.preventDefault();
                    alert("选择两个商品不可以同时回毛!请重新选择");
                    return false;
                }
            }

        }
        var item = [];
        for(var i=0;i<tmp.length;i++){
            item.push(tmp[i].id);
        }
        var rowdata = {
            'name': values[0]['name'],  //获取了的物品种
            'purchase_order':item,
        };
        var dataSum = $.extend(values[0],rowdata);
        delete dataSum['remarks'];
        delete dataSum['complete_return'];
        //更新一行
        $('#chirdTable').bootstrapTable('updateRow',{index:$('#indexFlag').text(),row:dataSum});
    });

    //表格一提交事件
    function submitData1(){
        //获取所选择的数据
       var array = getSelect('basicTable');
       $.each(array, function(key, value){
            value[0] = '';
       });
       var json_data = JSON.stringify(array);
       $.ajax({
           type: 'POST',
           dataType: 'json',
           contentType: 'application/json',
           data: json_data,
           url: "{% url 'purchaseOrder-list' %}",
           error:function(data){
               var response_data = data.responseJSON;
               console.log(response_data);
               if(response_data['non_field_errors']){
                   alert("提交失败: " + response_data['non_field_errors']);
                   return false;
               }
               alert('提交失败');
               for(var i = 0; i <response_data.length; i++){
                   $("#basicTable").bootstrapTable('check', response_data[i].index);
                   var index = response_data[i]['index'];
                   delete response_data[i]['index'];
                   $.each(response_data[i], function(key, value){
                       $("#basicTable").bootstrapTable("updateCell",{index:index,field:key,value:value[0]});
                       {#$("#basicTable").bootstrapTable("updateCell",{index:index,field:'error',value:true});#}
                   });
               }
           },
           success: function(data){
               alert('提交成功！');
               console.log(data);
               $("#basicTable").bootstrapTable('refresh');
               $("#secondTab").bootstrapTable('refresh');
           },
        });
    }
    //表格二提交事件
    function submitData2(){
        //获取所选择的数据
        var array = getSelect('chirdTable');
        $.each(array, function(key, value){
            value[0] = '';
        });
        var json_data = JSON.stringify(array);
        $.ajax({
            type: 'POST',
            dataType: 'json',
            contentType: 'application/json',
            data: json_data,
            url: "{% url 'take_goods-list' %}",
            error:function(data){
                var response_data = data.responseJSON;
                console.log(response_data);
                if(response_data['non_field_errors']){
                    alert("提交失败: " + response_data['non_field_errors']);
                    return false;
                }
                if(response_data[0]['non_field_errors']){
                    alert("提交失败: " + response_data[0]['non_field_errors']);
                    return false;
                }
                alert('提交失败');
                for(var i = 0; i <response_data.length; i++){
                    $("#chirdTable").bootstrapTable('check', response_data[i].index);
                    var index = response_data[i]['index'];
                    delete response_data[i]['index'];
                    $.each(response_data[i], function(key, value){
                        $("#chirdTable").bootstrapTable("updateCell",{index:index,field:key,value:value[0]});
                        {#$("#basicTable").bootstrapTable("updateCell",{index:index,field:'error',value:true});#}
                    });
                }
            },
            success: function(data){
                alert('提交成功！');
                console.log(data);
                $("#chirdTable").bootstrapTable('refresh');
                $("#secondTab").bootstrapTable('refresh');
            },
        });
    }

    //为所有回毛结束的数据添加一个背景
    function complete_return_style(row,index){
        if(row.hasOwnProperty('complete_return')){
            if(row.complete_return == '已结束'){
                return {css:{'background-color': 'pink'}};
            }else{
                return "";
            }
        }else{
            return "";
        }
    }
    //回毛结束点击事件
    function complete_return(){
        //获取所选择的数据
        var array = getSelect('basicTable');
        $.each(array, function(key, value){
            value[0] = '';
        });
        var json_data = JSON.stringify(array);
        $.ajax({
            type: 'POST',
            dataType: 'json',
            contentType: 'application/json',
            data: json_data,
            url: "{% url 'complete_return_purchase' %}",
            error:function(data){
                alert('提交失败');
                for(var i = 0; i <data.responseJSON.length; i++){
                    $("#basicTable").bootstrapTable('check', data.responseJSON[i].index);
                }
                console.log(data.responseJSON);
            },
            success: function(data){
                alert('提交成功！');
                console.log(data);
                $("#basicTable").bootstrapTable('refresh');
                $("#chirdTable").bootstrapTable('refresh');
                $("#secondTab").bootstrapTable('refresh');
            },
        });
    }
    </script>

</body>

</html>
